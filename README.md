# Applications Metrics 

A system that enables users to post and visualize metrics to specific applications

## Table of Contents

- [Requirments](#requirments)
- [Screenshots](#screenshots)
- [Installation](#installation)
- [Technical design](#technical-design)

## Requirments

- Users should be allowed to create `application`, each application should be holding `metrics`
- Users should be able to list the available `applications` paginated.
- Users should be able to create `metrics` for an `application`. Each metric should have:
    - `name` a string value
    - `value` a umeric value
    - `timestamp` a datetime 
- Users should be able to list the created `metrics` for specific `application`. In the list view, the users should be able to see these aggregations:
    - AVG
    - p99
    - p95
    - p50 (median)
- Users should be able to see the `metric` detailed aggregations grouped by these durations:
    - minute
    - hour
    - day
    - week
    - month
    - quarter
    - year

## Screenshots
- List applications view
![List applications view](screenshots/list_applications.png)
- Create application modal
![Create application modal](screenshots/create_application_modal.png)
- Application metrics list with stats
![Application metrics list with stats](screenshots/metrics_list.png)
- Single application metric timeline
![Single application metric timeline](screenshots/single_metric_aggregations_grouped.png)
- Create application metric datapoint
![Create application metric datapoint](screenshots/create_metric_datapoint.png)

## Installation
The repo has 3 folders:
- `metrics-api`. A rails 7 app that has all the backend logic
- `metrics-spa`. A singe page app written in react.
- `metrics-api-clients`. Auto generated clients derived form the openapi specs defined by the rails app. Check the folder readme for more info

In order to start the backend and the frontend, in the `metrics-api` run;
```
$ docker-compose up -d
```
The frontend app runs at port 3001, and rails app is running at port 3000

In order to run linter:
```
$ docker-compose exec web bundle exec rubocop
```
In order to run specs:
```
$ docker-compose exec web bundle exec rspec
```
In order to run DB seeder:
```
$ docker-compose exec web bundle exec rake db:seed
```

### Backend technologies
- Rails 7 app that uses these services:
    - Postgres
    - Redis
    - Sidekiq
    - Opensearch
    - Fully docerized + docker compose file that includes all required services.
    - The service is using rubocop to enforce coding styling.
- Full test coverage written using rspec.
- Functionalities divided by service objects.
- All endpoints documents in `openapi.yml` file.

### Frontend technologies
- A single page app written in TS.
- The app is generated by create-react-app.
- API layer is using axios.
- Tailwind is being used for styling.

## Technical design

### Database diagram
```mermaid
erDiagram
    APPLICATION {
        id BINARY
        name STRING
        created_at DATETIME
        updated_at DATETIME
    }
    METRIC {
        id BINARY
        name STRING
        value BIGINT
        timestamp BIGINT
        application_id BINARY
        created_at DATETIME
        updated_at DATETIME
    }
    APPLICATION ||--o{ METRIC : "many"
```

### Flows
#### Create application
```mermaid
sequenceDiagram
    participant UI
    participant SERVER
    participant DB
    participant CACHE

    UI->>SERVER: create application request
    SERVER->>SERVER: validate request body
    SERVER->>DB: insert application record into DB
    DB->>SERVER: success
    SERVER->>CACHE: add the newly created application_id into the registered applications set
    CACHE->>SERVER: success
    SERVER->>UI: success 
```
#### List applications
```mermaid
sequenceDiagram
    participant UI
    participant SERVER

    UI->>SERVER: list applications request
    SERVER->>DB: get applications paginated
    DB->>SERVER: query result
    SERVER->>UI: return applications list paginated 
```
#### List application metrics
```mermaid
sequenceDiagram
    participant UI
    participant SERVER
    participant ELASTICSEARCH


    UI->>SERVER: list application metrics request
    SERVER->>ELASTICSEARCH: Build aggregation query
    ELASTICSEARCH->>SERVER: aggregated query result
    SERVER->>SERVER: parse aggregation query buckets and build the response for UI
    SERVER->>UI: return the parsed aggeregated response
```
#### Show application metric timeline
```mermaid
sequenceDiagram
    participant UI
    participant SERVER
    participant ELASTICSEARCH


    UI->>SERVER: show application metric timeline request
    SERVER->>ELASTICSEARCH: Build aggregation query
    ELASTICSEARCH->>SERVER: aggregated query result
    SERVER->>SERVER: parse aggregation query buckets and build the response for UI
    SERVER->>UI: return the parsed aggeregated response
```
#### Create application metric datapoints
```mermaid
sequenceDiagram
    participant CLIENT
    participant SERVER
    participant CACHE
    participant SIDEKIQ_CREATE_METRICS_WORKER
    participant DB
    participant SIDEKIQ_ES_INDEXER_WORKER
    participant ELASTICSEARCH


    CLIENT->>SERVER: create metrics
    SERVER->>CACHE: Check if the sent application is a regiestered application
    CACHE->>SERVER: registered application cache query result
    alt is regiestered
        SERVER->>SIDEKIQ_CREATE_METRICS_WORKER: Enqueues a background job to process metrics batch async
        SERVER->>CLIENT: send acknledge to client
        SIDEKIQ_CREATE_METRICS_WORKER->>SIDEKIQ_CREATE_METRICS_WORKER: process the create metrics batch job
        SIDEKIQ_CREATE_METRICS_WORKER->>DB: Bulk insert metrics
        DB->>SIDEKIQ_CREATE_METRICS_WORKER: return the created metrics ids
        SIDEKIQ_CREATE_METRICS_WORKER->>SIDEKIQ_ES_INDEXER_WORKER: Enqueue a job to index the ceated metrics into elasticsearch
        SIDEKIQ_ES_INDEXER_WORKER->>SIDEKIQ_ES_INDEXER_WORKER: Picks up the indexing background job
        SIDEKIQ_ES_INDEXER_WORKER->>ELASTICSEARCH: Bulk index metrics
        ELASTICSEARCH->>SIDEKIQ_ES_INDEXER_WORKER: Bulk index response
    else is not regiestered
        SERVER->>CLIENT: send a bad request response to the client
    end
```
